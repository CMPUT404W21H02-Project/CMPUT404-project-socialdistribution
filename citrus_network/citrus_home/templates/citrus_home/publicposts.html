<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">

    <title>Citrus Network</title>
  </head>
  <body>
    {% include '../navbar-logged-in.html' %}
    <div class="container">
        <!-- Display the stream -->
        <div class="row justify-content-center mt-5 mb-1 stream-post">
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script 
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
    <script>
        function fetchJSON(url) {
            var request = new Request(url);
            return fetch(request).then((response) => {
                if (response.status === 200 || response.status === 404) { // OK
                    return response.json(); // return a Promise
                } else {
                    alert("Something went wrong: " + response.status);
                }});
            }

        // get stream gets it as a json which is setup for pagination in mind. This will be needed
        // to implement an "infinite scroll" as the number of posts in the stream increases beyond
        // what we should get in a single call.
        function getStream() {
            fetchJSON("{% url 'public_posts' %}").then((json) => {
                for(var i in json.message){
                    if (json.message[i].author.id.includes("/author/")) {
                        json.message[i].author.id = json.message[i].author.id.split("/author/")[1]
                    }
                    if (json.message[i].id.includes("/posts/")) {
                        json.message[i].id = json.message[i].id.split("/posts/")[1]
                    }
                    var newElement = document.createElement('div');
                    var classAttr = document.createAttribute("class");
                    classAttr.value = "col-md-10 col-sm-12 mt-1 mb-1 position-relative";
                    newElement.setAttributeNode(classAttr);
                    let url = "{% url 'render_profile' %}" + json.message[i].author.id
                    var postHtml = '<div class="card">' + '<div class="card-header"><a class="card-link" href="' + url + '">' + 
                        '<p style="margin: 0;"><strong>' + json.message[i].author.displayName + '</strong></p>' +
                        '<p style="margin: 0;">' + json.message[i].published + ' | ' + json.message[i].origin + '</p>' +
                        '</a>';

                    for (var j in json.message[i].categories) {
                        postHtml += '<a class="btn mt-1 btn-sm btn-outline-info rounded-pill" href="#tag">' + json.message[i].categories[j] + '</a>'
                    }
                    postHtml += '</div><a class="card-body card-link" href=../service/author/' + 
                        json.message[i].author.id + '/view-post/' + json.message[i].id + '/>' + 
                        '<h6 class="font-weight-bold">' + json.message[i].title + '</h6>';
                    
                    if (json.message[i].contentType === "image/png;base64" || json.message[i].contentType === "image/jpeg;base64"){
                        postHtml += '<img src=\"' + json.message[i].content + '\"/>';
                    } else if (json.message[i].contentType === "text/markdown") {
                        postHtml += marked(json.message[i].content)
                    } else{
                        let lines = json.message[i].content.split('\n');
                        
                        postHtml += '<p>';
                        for (var j of lines) {
                            postHtml += j + '<br>'
                        }
                        postHtml +='</p>';
                        // console.log(marked(json.message[i].content));
                    }
                    newElement.innerHTML = postHtml;

                    document.querySelector(".stream-post").appendChild(newElement);
                }
            });
        }

        window.onload = function() {
            getStream();
        }
    </script>
  </body>
</html>
<style>
    a.card-link {
        color: inherit;
        text-decoration: inherit;
    }
    p.github-activity{
        font-size: x-small;
    }
    div.header-buttons{
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: row;
    }
    div.button-nav{
        margin-top: 3em;
        margin-bottom:1em ;
    }
    a.nav-link{
        width: 100%;
    }
    #post-button{
        background-color: #1fb141;
        border-color: rgb(7, 128, 7) ;
    }
    #github-button{
        background-color: #1e88e5;
        border-color: #6789be;
    }
    .header-buttons .nav-button{
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        color: white;
        width: 100%;
        height: 100%;
        border-radius: 5px;
        border-width: 3px;
        font-size: large;
    }
    .header-buttons .nav-button:hover{
       
        box-shadow: 0 2px 4px 0 rgba(65, 64, 64, 0.24), 0 4px 8px 0 rgba(65,64,64,0.24);
        border-radius: 5px;
    }
    
    
</style>